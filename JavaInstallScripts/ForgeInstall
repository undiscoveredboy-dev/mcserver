#!/bin/bash

sudo apt update -qq
sudo apt install -y -qq jq curl

export MAIN_DIR=$(pwd)
echo -e '> fetching forge versions data...'

JSON_DATA=$(curl -sSL https://files.minecraftforge.net/maven/net/minecraftforge/forge/promotions_slim.json)
FILE_SITE=https://maven.minecraftforge.net/net/minecraftforge/forge/

cd ..
rm -f ./startJavaServer
wget -q https://raw.githubusercontent.com/lordofwizard/mcserver/main/startJavaServer
chmod +x ./startJavaServer

mkdir -p server
cd server

echo -e '\n> Visit https://files.minecraftforge.net/net/minecraftforge/forge/promotions_slim.json for available versions'

# -----------------------------
# Forge build type selection
# -----------------------------
echo -e "\n> Enter Forge build type (default 1):"
echo -e "  [1] recommended"
echo -e "  [2] latest"
read BUILD_TYPE

[[ -z $BUILD_TYPE ]] && BUILD_TYPE=1

if [[ $BUILD_TYPE -eq 1 ]]; then
    BUILD_TYPE=recommended
elif [[ $BUILD_TYPE -eq 2 ]]; then
    BUILD_TYPE=latest
else
    echo -e "> Invalid option"
    cd "$MAIN_DIR"
    ./ForgeInstall
    exit 1
fi

echo -e "> Build type selected: $BUILD_TYPE"

# -----------------------------
# Minecraft version (FROM ENV)
# -----------------------------
MC_VERSION="${MC_VERSION:-latest}"
echo -e "\n> Using Minecraft version: $MC_VERSION"

if [ "$MC_VERSION" == "latest" ]; then
    MC_VERSION=$(echo "${JSON_DATA}" | jq -r '.promos | to_entries[] | .key | select(contains("latest")) | split("-")[0]' \
        | sort -t. -k2,2n -k3,3n -k4,4n | tail -1)
fi

# -----------------------------
# Forge version resolution
# -----------------------------
if [ -n "$FORGE_VERSION" ]; then
    DOWNLOAD_LINK=https://maven.minecraftforge.net/net/minecraftforge/forge/${FORGE_VERSION}-${BUILD_TYPE}/forge-${FORGE_VERSION}
else
    echo -e "\n> Minecraft version: ${MC_VERSION}"
    echo -e "> Build type: ${BUILD_TYPE}\n"

    VERSION_KEY=$(echo "${JSON_DATA}" | jq -r \
        --arg MC_VERSION "$MC_VERSION" \
        --arg BUILD_TYPE "$BUILD_TYPE" \
        '.promos | to_entries[] | .key | select(contains($MC_VERSION)) | select(contains($BUILD_TYPE))' | head -1)

    if [[ -z "$VERSION_KEY" && "$BUILD_TYPE" == "latest" ]]; then
        echo -e "> No recommended build found, falling back to latest"
        VERSION_KEY=$(echo "${JSON_DATA}" | jq -r \
            --arg MC_VERSION "$MC_VERSION" \
            '.promos | to_entries[] | .key | select(contains($MC_VERSION)) | select(contains("latest"))' | head -1)
    fi

    if [[ -z "$VERSION_KEY" || "$VERSION_KEY" == "null" ]]; then
        echo -e "> No valid Forge version found for Minecraft $MC_VERSION"
        exit 1
    fi

    FORGE_VERSION=$(echo "${JSON_DATA}" | jq -r --arg KEY "$VERSION_KEY" '.promos[$KEY]')

    if [[ "$MC_VERSION" == "1.7.10" || "$MC_VERSION" == "1.8.9" ]]; then
        DOWNLOAD_LINK=${FILE_SITE}${MC_VERSION}-${FORGE_VERSION}-${MC_VERSION}/forge-${MC_VERSION}-${FORGE_VERSION}-${MC_VERSION}
    else
        DOWNLOAD_LINK=${FILE_SITE}${MC_VERSION}-${FORGE_VERSION}/forge-${MC_VERSION}-${FORGE_VERSION}
    fi
fi

# -----------------------------
# Download + install
# -----------------------------
echo -e "\n> Downloading Forge $FORGE_VERSION"
echo -e "> URL: ${DOWNLOAD_LINK}-installer.jar"

if ! curl --silent --head --fail "${DOWNLOAD_LINK}-installer.jar"; then
    echo -e "> Invalid Forge download link"
    exit 2
fi

curl -sSL -o installer.jar "${DOWNLOAD_LINK}-installer.jar"

if [ ! -f installer.jar ]; then
    echo -e "> Forge installer download failed"
    exit 3
fi

echo -e "\n> Installing Forge server"
java -jar installer.jar --installServer || { echo -e "> Forge install failed"; exit 4; }

rm -f installer.jar

# -----------------------------
# Server launch files
# -----------------------------
cd "$MAIN_DIR/../server"
echo "eula=true" > eula.txt

FORGE_RUN_FILE=./run.sh

if [ -f "$FORGE_RUN_FILE" ]; then
    cat > run.sh <<EOF
#!/bin/bash
export JAVA=../bin/java_bins/bin/java
\$JAVA @user_jvm_args.txt @libraries/net/minecraftforge/forge/${MC_VERSION}-${FORGE_VERSION}/unix_args.txt "\$@"
EOF
    chmod +x run.sh

    cat > ../startJavaServer <<EOF
#!/bin/bash
cd server
./run.sh -nogui
EOF
    chmod +x ../startJavaServer
else
    if [[ "$MC_VERSION" == "1.7.10" || "$MC_VERSION" == "1.8.9" ]]; then
        FORGE_JAR=forge-${MC_VERSION}-${FORGE_VERSION}-${MC_VERSION}-universal.jar
    else
        FORGE_JAR=forge-${MC_VERSION}-${FORGE_VERSION}.jar
    fi

    mv "$FORGE_JAR" server.jar
fi
